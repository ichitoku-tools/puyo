
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>MiniPuyo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {
      background: #222;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      margin: 0;
      font-family: sans-serif;
    }
    canvas {
      background: #000;
      border: 3px solid #fff;
    }
  </style>
</head>
<body>
  <canvas id="puyo" width="180" height="360"></canvas>
  <script>
    const canvas = document.getElementById('puyo');
    const ctx = canvas.getContext('2d');
    const COLS = 6, ROWS = 12, BLOCK = 30;
    const field = Array.from({length: ROWS}, () => Array(COLS).fill(0));
    const colors = [null, '#ff4d4d', '#4da6ff']; // 赤・青

    let pair = {
      blocks: [[1, 2]], // 赤と青のぷよ
      x: 2,
      y: 0
    };

    function drawBlock(x, y, color) {
      const grad = ctx.createRadialGradient(
        x * BLOCK + BLOCK / 2, y * BLOCK + BLOCK / 2, 5,
        x * BLOCK + BLOCK / 2, y * BLOCK + BLOCK / 2, BLOCK / 2
      );
      grad.addColorStop(0, '#fff');
      grad.addColorStop(1, color);
      ctx.fillStyle = grad;
      ctx.beginPath();
      ctx.arc(x * BLOCK + BLOCK / 2, y * BLOCK + BLOCK / 2, BLOCK / 2 - 2, 0, Math.PI * 2);
      ctx.fill();
    }

    function drawField() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      for (let y = 0; y < ROWS; y++) {
        for (let x = 0; x < COLS; x++) {
          if (field[y][x]) drawBlock(x, y, colors[field[y][x]]);
        }
      }
      pair.blocks.forEach((val, i) => {
        drawBlock(pair.x, pair.y - i, colors[val]);
      });
    }

    function drop() {
      pair.y++;
      if (collides()) {
        pair.y--;
        fixToField();
        clearMatches();
        spawn();
      }
    }

    function collides() {
      return pair.blocks.some((_, i) => {
        const y = pair.y - i;
        return y >= ROWS || field[y][pair.x];
      });
    }

    function fixToField() {
      pair.blocks.forEach((val, i) => {
        const y = pair.y - i;
        if (y >= 0) field[y][pair.x] = val;
      });
    }

    function clearMatches() {
      const toClear = [];
      const visited = Array.from({length: ROWS}, () => Array(COLS).fill(false));

      function dfs(x, y, color, group) {
        if (x < 0 || y < 0 || x >= COLS || y >= ROWS) return;
        if (visited[y][x] || field[y][x] !== color) return;
        visited[y][x] = true;
        group.push([x, y]);
        [[0,1],[1,0],[-1,0],[0,-1]].forEach(([dx,dy]) => dfs(x+dx, y+dy, color, group));
      }

      for (let y = 0; y < ROWS; y++) {
        for (let x = 0; x < COLS; x++) {
          if (field[y][x] && !visited[y][x]) {
            const group = [];
            dfs(x, y, field[y][x], group);
            if (group.length >= 4) toClear.push(...group);
          }
        }
      }

      toClear.forEach(([x, y]) => field[y][x] = 0);
      applyGravity();
    }

    function applyGravity() {
      for (let x = 0; x < COLS; x++) {
        let stack = [];
        for (let y = ROWS - 1; y >= 0; y--) {
          if (field[y][x]) {
            stack.push(field[y][x]);
            field[y][x] = 0;
          }
        }
        for (let y = ROWS - 1, i = 0; i < stack.length; y--, i++) {
          field[y][x] = stack[i];
        }
      }
    }

    function spawn() {
      pair = { blocks: [Math.random() < 0.5 ? 1 : 2, Math.random() < 0.5 ? 1 : 2], x: 2, y: 0 };
      if (collides()) {
        alert("ゲームオーバー！");
        for (let y = 0; y < ROWS; y++) field[y].fill(0);
      }
    }

    document.addEventListener('keydown', e => {
      if (e.key === 'ArrowLeft' && pair.x > 0) {
        pair.x--;
        if (collides()) pair.x++;
      }
      if (e.key === 'ArrowRight' && pair.x < COLS - 1) {
        pair.x++;
        if (collides()) pair.x--;
      }
      if (e.key === 'ArrowDown') {
        drop();
      }
    });

    function update() {
      drop();
      drawField();
      setTimeout(() => { update(); }, 500);
    }

    spawn();
    drawField();
    update();
  </script>
</body>
</html>
